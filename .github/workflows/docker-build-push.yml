name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*.*.*'
      - '!v*.*.*-chart'  # Exclude tags ending with -chart

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Pack CLI
        uses: buildpacks/github-actions/setup-pack@v5.7.4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image with Cloud Native Buildpacks
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          IMAGE_LATEST="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          CACHE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildpack-cache"

          # Build image using Paketo buildpacks for Node.js with cache
          pack build "${IMAGE_TAG}" \
            --builder paketobuildpacks/builder-jammy-base \
            --cache-image "${CACHE_IMAGE}" \
            --publish

          # Tag as latest
          docker pull "${IMAGE_TAG}"
          docker tag "${IMAGE_TAG}" "${IMAGE_LATEST}"
          docker push "${IMAGE_LATEST}"

      - name: Output image details
        run: |
          echo "Image pushed successfully!"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
